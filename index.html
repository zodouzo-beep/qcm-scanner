<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f9; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        video { width: 100%; max-width: 400px; border: 3px solid #333; border-radius: 10px; }
        input { font-size: 16px; padding: 10px; margin-bottom: 10px; width: 90%; max-width: 300px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 15px; font-size: 18px; background: #28a745; color: white; border: none; border-radius: 5px; width: 90%; max-width: 300px; cursor: pointer; }
        #resultat { margin-top: 15px; font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Scanner de QCM</h1>
    
    <!-- ETAPE 1 : LE PROFESSEUR RENTRE LE CORRIG√â -->
    <div class="card" style="border-left: 5px solid #007bff;">
        <h3>1. Configuration de l'examen</h3>
        <p style="font-size: 12px; color: gray;">Tapez les bonnes r√©ponses √† la suite (ex: ACBDAB...)</p>
        <input type="text" id="corrige_prof" placeholder="Ex: ACBDACBD..." value="ACBDACBDACBDACBDACBD">
    </div>

    <!-- ETAPE 2 : LE PROFESSEUR SCANNE UN √âL√àVE -->
    <div class="card" style="border-left: 5px solid #28a745;">
        <h3>2. Scanner une copie</h3>
        <input type="text" id="nom_eleve" placeholder="Nom de l'√©l√®ve (ex: Jean)">
        <video id="video" autoplay playsinline></video>
        <button id="btn-scan">üì∑ Corriger & Sauvegarder</button>
        <div id="resultat"></div>
    </div>

    <script>
        // --- 1. CONFIGURATION SUPABASE (Laissez vos cl√©s ici) ---
        const supabaseUrl = "https://gnfaccqhvepkpoqvsnjq.supabase.co"; 
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZmFjY3FodmVwa3BvcXZzbmpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMTk3NjUsImV4cCI6MjA4NzU5NTc2NX0.0hKHcnHX7Aj2yowc0r1GGAQIChLmJ3bv_YTnEUZGzeo"; 
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        const video = document.getElementById('video');
        const btnScan = document.getElementById('btn-scan');
        const divResultat = document.getElementById('resultat');
        const inputNom = document.getElementById('nom_eleve');
        const inputCorrige = document.getElementById('corrige_prof');

        // Allumer la cam√©ra
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => { divResultat.innerText = "Erreur cam√©ra : " + err; });

        // --- 2. LOGIQUE DE CORRECTION ---
        btnScan.addEventListener('click', async () => {
            const nomEleve = inputNom.value || "Anonyme";
            const corrigeExamen = inputCorrige.value.toUpperCase(); // On r√©cup√®re le corrig√© du prof en majuscules

            if (corrigeExamen.length === 0) {
                alert("Veuillez d'abord entrer le corrig√© !");
                return;
            }

            divResultat.innerText = "Analyse de la copie...";
            divResultat.style.color = "black";

            // ---------------------------------------------------------
            // üö® ICI, PLUS TARD, OPENCV LIRA LA VRAIE COPIE.
            // Pour l'instant, on simule que l'√©l√®ve a r√©pondu √ßa (avec 3 fautes) :
            const reponsesEleveSimulees = "ACBDACBDACXDXCBDACBD"; 
            // ---------------------------------------------------------

            // --- 3. COMPARAISON ET NOTATION ---
            let points = 0;
            let questionsCorrigees = Math.min(corrigeExamen.length, reponsesEleveSimulees.length);

            // On compare lettre par lettre
            for (let i = 0; i < questionsCorrigees; i++) {
                if (reponsesEleveSimulees[i] === corrigeExamen[i]) {
                    points += 1; // Bonne r√©ponse : +1 point
                }
            }

            // --- 4. ENVOI √Ä SUPABASE ---
            const { data, error } = await supabase
                .from('resultats')
                .insert([
                    { eleve_nom: nomEleve, note: points, total: questionsCorrigees }
                ]);

            if (error) {
                divResultat.innerText = "Erreur de base de donn√©es.";
                divResultat.style.color = "red";
            } else {
                divResultat.innerText = `‚úÖ ${nomEleve} a eu : ${points} / ${questionsCorrigees}`;
                divResultat.style.color = "green";
                inputNom.value = ""; // On vide le nom pour passer √† l'√©l√®ve suivant
            }
        });
    </script>
</body>
</html>
