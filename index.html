<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QCM Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f4f4f9;
      padding: 10px;
      margin: 0;
    }

    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 15px auto;
      max-width: 500px;
    }

    video {
      width: 100%;
      max-width: 400px;
      border: 3px solid #333;
      border-radius: 10px;
      background: #000;
      margin-top: 10px;
    }

    input {
      font-size: 16px;
      padding: 10px;
      margin: 8px 0;
      width: 90%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      padding: 15px;
      font-size: 18px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      width: 90%;
      max-width: 300px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:disabled {
      background: #999;
      cursor: not-allowed;
    }

    #resultat {
      margin-top: 15px;
      font-size: 20px;
      font-weight: bold;
      min-height: 30px;
    }

    .hint {
      font-size: 12px;
      color: gray;
    }
  </style>
</head>
<body>

  <h1>Scanner de QCM</h1>

  <!-- ETAPE 1 -->
  <div class="card" style="border-left: 5px solid #007bff;">
    <h3>1. Configuration de l'examen</h3>
    <p class="hint">Tapez les bonnes rÃ©ponses Ã  la suite (ex: ACBDAB...)</p>
    <input
      type="text"
      id="corrige_prof"
      placeholder="Ex: ACBDACBD..."
      value="ACBDACBDACBDACBDACBD"
    />
  </div>

  <!-- ETAPE 2 -->
  <div class="card" style="border-left: 5px solid #28a745;">
    <h3>2. Scanner une copie</h3>
    <input type="text" id="nom_eleve" placeholder="Nom de l'Ã©lÃ¨ve (ex: Jean)" />
    <video id="video" autoplay playsinline muted></video>
    <button id="btn-scan">ðŸ“· Corriger & Sauvegarder</button>
    <div id="resultat"></div>
  </div>

  <script>
    // =========================
    // 1) CONFIGURATION SUPABASE
    // =========================
    const supabaseUrl = "https://gnfaccqhvepkpoqvsnjq.supabase.co";
    const supabaseKey = "VOTRE_CLE_ANON_ICI";

    // IMPORTANT : ne pas appeler la variable "supabase"
    // car "window.supabase" est dÃ©jÃ  le SDK chargÃ© par le CDN.
    const db = window.supabase.createClient(supabaseUrl, supabaseKey);

    // =========================
    // 2) ELEMENTS DOM
    // =========================
    const video = document.getElementById("video");
    const btnScan = document.getElementById("btn-scan");
    const divResultat = document.getElementById("resultat");
    const inputNom = document.getElementById("nom_eleve");
    const inputCorrige = document.getElementById("corrige_prof");

    let cameraStream = null;

    function setResultat(message, color = "black") {
      divResultat.innerText = message;
      divResultat.style.color = color;
    }

    // =========================
    // 3) DEMARRER CAMERA
    // =========================
    async function demarrerCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setResultat("CamÃ©ra non disponible (HTTPS ou navigateur requis).", "red");
        return;
      }

      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = cameraStream;
      } catch (err) {
        setResultat("Erreur camÃ©ra : " + err.message, "red");
      }
    }

    demarrerCamera();

    // =========================
    // 4) NORMALISATION REPONSES
    // =========================
    function nettoyerReponses(texte) {
      return (texte || "")
        .toUpperCase()
        .replace(/[^ABCD]/g, "");
    }

    // =========================
    // 5) CORRECTION
    // =========================
    btnScan.addEventListener("click", async () => {
      const nomEleve = inputNom.value.trim() || "Anonyme";
      const corrigeExamen = nettoyerReponses(inputCorrige.value);

      if (!corrigeExamen) {
        alert("Veuillez d'abord entrer le corrigÃ© !");
        return;
      }

      btnScan.disabled = true;
      setResultat("Analyse de la copie...", "black");

      try {
        // ---------------------------------------------------------
        // Simulation temporaire
        // Plus tard, cette variable viendra d'OpenCV / OCR
        const reponsesEleveSimulees = nettoyerReponses("ACBDACBDACXDXCBDACBD");
        // ---------------------------------------------------------

        const questionsCorrigees = Math.min(
          corrigeExamen.length,
          reponsesEleveSimulees.length
        );

        let points = 0;

        for (let i = 0; i < questionsCorrigees; i++) {
          if (reponsesEleveSimulees[i] === corrigeExamen[i]) {
            points += 1;
          }
        }

        const { error } = await db
          .from("resultats")
          .insert([
            {
              eleve_nom: nomEleve,
              note: points,
              total: questionsCorrigees
            }
          ]);

        if (error) {
          console.error("Erreur Supabase :", error);
          setResultat("Erreur de base de donnÃ©es : " + error.message, "red");
          return;
        }

        setResultat(`âœ… ${nomEleve} a eu : ${points} / ${questionsCorrigees}`, "green");
        inputNom.value = "";
      } catch (err) {
        console.error("Erreur :", err);
        setResultat("Erreur : " + err.message, "red");
      } finally {
        btnScan.disabled = false;
      }
    });

    // =========================
    // 6) NETTOYAGE CAMERA
    // =========================
    window.addEventListener("beforeunload", () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
      }
    });
  </script>
</body>
</html>
